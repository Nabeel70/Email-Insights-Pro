(()=>{var e={};e.id=938,e.ids=[938],e.modules={643:e=>{"use strict";e.exports=require("node:perf_hooks")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},8010:(e,t,r)=>{"use strict";r.d(t,{db:()=>o});var s=r(89579),a=r(34717),i=r(25492);let n=(0,s.Dk)().length?(0,s.Sx)():(0,s.Wp)({apiKey:"AIzaSyDLtdLHWg5nW07lFUlcmqsa90WKjTHMtlM",authDomain:"email-insights-pro-lcd3q.firebaseapp.com",projectId:"email-insights-pro-lcd3q",storageBucket:"email-insights-pro-lcd3q.firebasestorage.app",messagingSenderId:"56610768571",appId:"1:56610768571:web:04c62c52c047925da14b9e"}),o=(0,a.aU)(n);(0,i.xI)(n)},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12652:(e,t,r)=>{"use strict";r.r(t),r.d(t,{GET:()=>u});var s=r(67218);r(79130);var a=r(32190),i=r(95012),n=r(8010),o=r(34717);async function u(e){let t=(e.headers.get("authorization")||"").split("Bearer ").at(1);if(!process.env.CRON_SECRET||t!==process.env.CRON_SECRET)return a.NextResponse.json({error:"Unauthorized"},{status:401});try{console.log("HOURLY SYNC: Starting data synchronization...");let e=await (0,i.X)();console.log(`HOURLY SYNC: ${e.message}`);try{let t=(0,o.H9)(n.db,"jobStatus","hourlySync");await (0,o.BN)(t,{lastSuccess:new Date().toISOString(),status:"success",details:e.message},{merge:!0}),console.log("HOURLY SYNC: Successfully logged job status to Firestore.")}catch(e){console.error("HOURLY SYNC: Could not log job status to Firestore after successful sync.",e)}return a.NextResponse.json({success:!0,message:e.message})}catch(e){try{let t=(0,o.H9)(n.db,"jobStatus","hourlySync");await (0,o.BN)(t,{lastFailure:new Date().toISOString(),status:"failure",error:e.message},{merge:!0})}catch(e){console.error("HOURLY SYNC: Could not log job FAILURE status to Firestore.",e)}return console.error("HOURLY SYNC JOB FAILED:",e),a.NextResponse.json({error:e.message},{status:500})}}(0,r(17478).D)([u]),(0,s.A)(u,"4021651ff21da84d5fbe5317c7fd37f4266060acf0",null)},16141:e=>{"use strict";e.exports=require("node:zlib")},16698:e=>{"use strict";e.exports=require("node:async_hooks")},19771:e=>{"use strict";e.exports=require("process")},21820:e=>{"use strict";e.exports=require("os")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},32467:e=>{"use strict";e.exports=require("node:http2")},33873:e=>{"use strict";e.exports=require("path")},34589:e=>{"use strict";e.exports=require("node:assert")},34631:e=>{"use strict";e.exports=require("tls")},37067:e=>{"use strict";e.exports=require("node:http")},37366:e=>{"use strict";e.exports=require("dns")},37540:e=>{"use strict";e.exports=require("node:console")},41204:e=>{"use strict";e.exports=require("string_decoder")},41362:(e,t,r)=>{"use strict";r.d(t,{$T:()=>d,HW:()=>l,ME:()=>u,Mr:()=>p,iC:()=>f,mk:()=>c,qb:()=>n,tm:()=>o});var s=r(67218);r(79130);var a=r(17478);let i=process.env.EPMAILPRO_PUBLIC_KEY;async function n(e,t,r={},s=null){if(!i)throw Error("Missing EPMAILPRO_PUBLIC_KEY. Check your .env file and App Hosting backend configuration.");let a=t.startsWith("/")?t.substring(1):t,o=`https://app.epmailpro.com/api/${a}`,u={"X-MW-PUBLIC-KEY":i},c={method:e,headers:u,cache:"no-store"};if("GET"===e){let e=new URLSearchParams(Object.entries(r).map(([e,t])=>[e,String(t)]));e.toString()&&(o+=`?${e.toString()}`)}else s&&(u["Content-Type"]="application/json",c.body=JSON.stringify(s));let l={url:o,headers:{...u},body:c.body||null};try{let e=await fetch(o,c),t=await e.text();if(!e.ok){let r=`API request failed with status ${e.status}.`;try{let e=JSON.parse(t),s=e.error||(e.data?e.data.error:JSON.stringify(e));r+=` Details: ${s}`}catch(e){r+=` Response body: ${t}`}let s=Error(r);throw s.statusCode=e.status,s.requestInfo=l,s}if(!t)return{data:null,requestInfo:l};try{let e=JSON.parse(t);if(e.status&&"success"!==e.status){let t=Error(`API returned a failure status: ${JSON.stringify(e.error||e)}`);throw t.requestInfo=l,t}return{data:e.data?.records||e.data?.record||e.data||e,requestInfo:l}}catch(r){if("[]"===t)return{data:[],requestInfo:l};let e=Error(`Invalid JSON response from API. Raw text: ${t}`);throw e.requestInfo=l,e}}catch(e){throw e.requestInfo||(e.requestInfo=l),e}}async function o(e){try{let{data:t}=await n("GET",`campaigns/${e}`);if(!t)return null;return t}catch(t){return console.error(`Could not fetch details for campaign ${e}. Reason:`,t),null}}async function u(){let{data:e}=await n("GET","campaigns",{page:"1",per_page:"50"}),t=(Array.isArray(e)?e:e?.records)||[];if(0===t.length)return[];let r=t.map(e=>o(e.campaign_uid));return(await Promise.allSettled(r)).filter(e=>"fulfilled"===e.status&&null!==e.value).map(e=>e.value).filter(e=>{if(!e||!e.name)return!1;let t=e.name.toLowerCase();return!t.includes("farm")&&!t.includes("test")})}async function c(e){try{let{data:t}=await n("GET",`campaigns/${e}/stats`);if(!t||Array.isArray(t)&&0===t.length)return null;return{...t,campaign_uid:e}}catch(t){return console.error(`Could not fetch or process stats for campaign ${e}. Reason:`,t),null}}async function l(e){let{data:t}=await n("GET",`lists/${e}/subscribers`,{page:"1",per_page:"10000",status:"unsubscribed"});return(Array.isArray(t)?t:t?.records)||[]}async function d(e,t){try{let{data:r}=await n("GET",`lists/${e}/subscribers`,{EMAIL:t});if(!r||Array.isArray(r)&&0===r.length)return null;return(Array.isArray(r)?r:r.records)[0]||null}catch(e){if(404===e.statusCode)return null;return console.error(`Could not fetch details for subscriber ${t}. Reason:`,e),null}}async function p(){let{data:e}=await n("GET","lists");return((Array.isArray(e)?e:e?.records)||[]).filter(e=>{if(!e||!e.general?.name)return!1;let t=e.general.name.toLowerCase();return!t.includes("farm")&&!t.includes("test")})}async function f(e){let t,r="rg591800s2a2c",s=`suppression-lists/${r}/emails`;try{let a=await n("POST",s,{},{email:e});t={listUid:r,status:"success",data:a.data}}catch(e){t={listUid:r,status:"failed",error:e.message}}return{message:`Attempted to add '${e}' to suppression list ${r}.`,success:"success"===t.status,result:t}}(0,a.D)([n,o,u,c,l,d,p,f]),(0,s.A)(n,"7852ec3e7ddc063b967db2f7fa0623d0218c23a252",null),(0,s.A)(o,"402d30a181f7d9d554d07daf8513ef4b075d357756",null),(0,s.A)(u,"0067fe022ae68bb788d0078518de7518dd262db809",null),(0,s.A)(c,"401debd37c56a1149e44bf2d2bcd5ed06b8e3ca457",null),(0,s.A)(l,"4061fbe8a50e3fd214674a2e1bfed3286bb3b0afb4",null),(0,s.A)(d,"606f0c2220a7ea490bc89fc1a2d9eb7648a15a3281",null),(0,s.A)(p,"00807426360c2866649fea2b69a90e07a1eab79d6d",null),(0,s.A)(f,"40ee5602e76ad4c4ecc1742a645ea73634620569cb",null)},41692:e=>{"use strict";e.exports=require("node:tls")},41792:e=>{"use strict";e.exports=require("node:querystring")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},53053:e=>{"use strict";e.exports=require("node:diagnostics_channel")},55511:e=>{"use strict";e.exports=require("crypto")},57075:e=>{"use strict";e.exports=require("node:stream")},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73136:e=>{"use strict";e.exports=require("node:url")},73429:e=>{"use strict";e.exports=require("node:util/types")},73496:e=>{"use strict";e.exports=require("http2")},74075:e=>{"use strict";e.exports=require("zlib")},75919:e=>{"use strict";e.exports=require("node:worker_threads")},77030:e=>{"use strict";e.exports=require("node:net")},77598:e=>{"use strict";e.exports=require("node:crypto")},78335:()=>{},78474:e=>{"use strict";e.exports=require("node:events")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},89568:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>d,routeModule:()=>o,serverHooks:()=>l,workAsyncStorage:()=>u,workUnitAsyncStorage:()=>c});var s=r(96559),a=r(48088),i=r(37719),n=r(12652);let o=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cron/hourly-sync/route",pathname:"/api/cron/hourly-sync",filename:"route",bundlePath:"app/api/cron/hourly-sync/route"},resolvedPagePath:"/home/user/studio/src/app/api/cron/hourly-sync/route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:u,workUnitAsyncStorage:c,serverHooks:l}=o;function d(){return(0,i.patchFetch)({workAsyncStorage:u,workUnitAsyncStorage:c})}},90439:(e,t,r)=>{"use strict";r.r(t),r.d(t,{"0067fe022ae68bb788d0078518de7518dd262db809":()=>i.ME,"00807426360c2866649fea2b69a90e07a1eab79d6d":()=>i.Mr,"00c6f1671d7098cc256129263c07149587dabcc5ec":()=>a.X,"401debd37c56a1149e44bf2d2bcd5ed06b8e3ca457":()=>i.mk,"4021651ff21da84d5fbe5317c7fd37f4266060acf0":()=>s.GET,"402d30a181f7d9d554d07daf8513ef4b075d357756":()=>i.tm,"4061fbe8a50e3fd214674a2e1bfed3286bb3b0afb4":()=>i.HW,"40ee5602e76ad4c4ecc1742a645ea73634620569cb":()=>i.iC,"606f0c2220a7ea490bc89fc1a2d9eb7648a15a3281":()=>i.$T,"7852ec3e7ddc063b967db2f7fa0623d0218c23a252":()=>i.qb});var s=r(12652),a=r(95012),i=r(41362)},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},95012:(e,t,r)=>{"use strict";r.d(t,{X:()=>d});var s=r(67218);r(79130);var a=r(8010),i=r(34717),n=r(41362);async function o(e){if(0===e.length)return;let t=(0,i.wP)(a.db),r=(0,i.rJ)(a.db,"rawCampaigns");e.forEach(e=>{let s=(0,i.H9)(r,e.campaign_uid);t.set(s,e,{merge:!0})}),await t.commit()}async function u(e){if(0===e.length)return;let t=(0,i.wP)(a.db),r=(0,i.rJ)(a.db,"rawStats");e.forEach(e=>{if(e){let s=(0,i.H9)(r,e.campaign_uid);t.set(s,e,{merge:!0})}}),await t.commit()}async function c(e){if(0===e.length)return;let t=(0,i.wP)(a.db),r=(0,i.rJ)(a.db,"rawLists");e.forEach(e=>{let s=(0,i.H9)(r,e.general.list_uid);t.set(s,e)}),await t.commit()}async function l(e){if(0===e.length)return;let t=(0,i.wP)(a.db),r=(0,i.rJ)(a.db,"rawUnsubscribes");e.forEach(e=>{if(e&&e.subscriber_uid){let s=(0,i.H9)(r,e.subscriber_uid);t.set(s,e)}}),await t.commit()}async function d(){console.log("Starting full data sync...");let e=await (0,n.ME)(),t=[];if(e.length>0){let r=e.map(e=>(0,n.mk)(e.campaign_uid));t=(await Promise.allSettled(r)).filter(e=>"fulfilled"===e.status&&e.value).map(e=>e.value)}await o(e),await u(t),console.log(`Synced ${e.length} campaigns and ${t.length} stats records.`);let r=await (0,n.Mr)(),s=[];if(r.length>0){let e=r.map(e=>(0,n.HW)(e.general.list_uid)),t=(await Promise.allSettled(e)).filter(e=>"fulfilled"===e.status&&null!==e.value).flatMap(e=>e.value),a=new Map;t.forEach(e=>{e&&e.subscriber_uid&&a.set(e.subscriber_uid,e)}),s=Array.from(a.values())}return await c(r),await l(s),console.log(`Synced ${r.length} lists and ${s.length} unsubscribers.`),{success:!0,message:`Sync complete. Fetched ${e.length} campaigns, ${t.length} stats, ${r.length} lists, and ${s.length} unsubscribers.`}}(0,r(17478).D)([d]),(0,s.A)(d,"00c6f1671d7098cc256129263c07149587dabcc5ec",null)},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[447,724,580,799],()=>r(89568));module.exports=s})();
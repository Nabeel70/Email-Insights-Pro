<!DOCTYPE html>
<html>
<head>
    <title>Test Sync Fix</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        
        // Mock Firebase functions
        const mockCollection = () => ({ docs: [] });
        const mockOnSnapshot = (collection, callback) => {
            // Simulate Firebase listener
            setTimeout(() => {
                callback({
                    docs: [{
                        id: 'hourlySync',
                        data: () => ({ status: 'success', duration: 30 })
                    }]
                });
            }, 100);
            return () => {}; // Unsubscribe function
        };
        const mockGetDocs = async () => ({ size: 10 });
        
        function TestSyncComponent() {
            const [hourlySyncStatus, setHourlySyncStatus] = useState({ status: 'pending' });
            const [syncStats, setSyncStats] = useState({
                campaigns: 0,
                stats: 0,
                lists: 0,
                unsubscribers: 0,
                lastSyncDuration: 0,
                totalSyncs: 0,
                successRate: 0
            });
            const [renderCount, setRenderCount] = useState(0);
            
            // Track renders to detect infinite loops
            useEffect(() => {
                setRenderCount(prev => prev + 1);
            });
            
            // This simulates the fixed loadSyncStats function
            const loadSyncStats = useCallback(async () => {
                try {
                    const campaigns = 10;
                    const stats = 20;
                    const lists = 5;
                    const unsubscribers = 3;

                    setSyncStats(prevStats => ({
                        ...prevStats,
                        campaigns,
                        stats,
                        lists,
                        unsubscribers,
                        totalSyncs: 247
                    }));
                } catch (error) {
                    console.error('Failed to load sync stats:', error);
                }
            }, []);

            // Load initial data
            useEffect(() => {
                loadSyncStats();
            }, [loadSyncStats]);

            // Listen to job status updates separately - FIXED VERSION
            useEffect(() => {
                const unsubHourlySync = mockOnSnapshot(mockCollection(), (snapshot) => {
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (doc.id === 'hourlySync') {
                            setHourlySyncStatus(prevStatus => {
                                // Only update if the data has actually changed
                                if (JSON.stringify(prevStatus) !== JSON.stringify(data)) {
                                    return data;
                                }
                                return prevStatus;
                            });
                        }
                    });
                });

                return () => {
                    unsubHourlySync();
                };
            }, []); // Note: No loadSyncStats dependency here

            // Update sync stats when specific fields change - FIXED VERSION
            useEffect(() => {
                setSyncStats(prevStats => ({
                    ...prevStats,
                    lastSyncDuration: hourlySyncStatus.duration || 0,
                    successRate: hourlySyncStatus.status === 'success' ? 98.5 : 85.0
                }));
            }, [hourlySyncStatus.status, hourlySyncStatus.duration]); // Specific dependencies only
            
            return (
                <div style={{ padding: '20px', fontFamily: 'Arial, sans-serif' }}>
                    <h1>Sync Component Test</h1>
                    <p>Render count: <strong>{renderCount}</strong> (should stabilize, not keep increasing)</p>
                    <p>Status: <strong>{hourlySyncStatus.status}</strong></p>
                    <p>Duration: <strong>{hourlySyncStatus.duration || 0}s</strong></p>
                    <p>Success Rate: <strong>{syncStats.successRate}%</strong></p>
                    <p>Total Records: <strong>{syncStats.campaigns + syncStats.stats + syncStats.lists + syncStats.unsubscribers}</strong></p>
                    {renderCount > 20 && (
                        <div style={{ color: 'red', fontWeight: 'bold' }}>
                            ⚠️ WARNING: Possible infinite loop detected! (Render count > 20)
                        </div>
                    )}
                    {renderCount <= 20 && renderCount > 5 && (
                        <div style={{ color: 'green', fontWeight: 'bold' }}>
                            ✅ Component appears stable (render count stabilized)
                        </div>
                    )}
                </div>
            );
        }
        
        ReactDOM.render(<TestSyncComponent />, document.getElementById('root'));
    </script>
</body>
</html>